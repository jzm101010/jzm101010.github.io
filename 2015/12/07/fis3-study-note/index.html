<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>fis3学习笔记 | Jyc&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="这几天一直在看fis3，仅通过这篇笔记记录一下自己的学习情况">
<meta property="og:type" content="article">
<meta property="og:title" content="fis3学习笔记">
<meta property="og:url" content="http://yoursite.com/2015/12/07/fis3-study-note/index.html">
<meta property="og:site_name" content="Jyc's Blog">
<meta property="og:description" content="这几天一直在看fis3，仅通过这篇笔记记录一下自己的学习情况">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="fis3学习笔记">
<meta name="twitter:description" content="这几天一直在看fis3，仅通过这篇笔记记录一下自己的学习情况">
  
    <link rel="alternative" href="/atom.xml" title="Jyc&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <script src="http://libs.baidu.com/jquery/1.9.0/jquery.js"></script>
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img lazy-src="http://7xiylb.com1.z0.glb.clouddn.com/author.jpg" class="js-avatar">
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">jyc</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Keep walking, keep learning</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/jzm101010" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/2851232800" title="weibo">weibo</a>
					        
								<a class="zhihu" target="_blank" href="http://www.zhihu.com/people/nan-gong-ye-zhi" title="zhihu">zhihu</a>
					        
								<a class="mail" target="_blank" href="/jycworking@163.com" title="mail">mail</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/fis3/" style="font-size: NaNpx;">fis3</a>
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">菜鸟一只，正在学习</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">jyc</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="http://7xiylb.com1.z0.glb.clouddn.com/author.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">jyc</h1>
			</hgroup>
			
			<p class="header-subtitle">Keep walking, keep learning</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/jzm101010" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/2851232800" title="weibo">weibo</a>
			        
						<a class="zhihu" target="_blank" href="http://www.zhihu.com/people/nan-gong-ye-zhi" title="zhihu">zhihu</a>
			        
						<a class="mail" target="_blank" href="/jycworking@163.com" title="mail">mail</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-fis3-study-note" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/12/07/fis3-study-note/" class="article-date">
  	<time datetime="2015-12-07T04:11:11.000Z" itemprop="datePublished">2015-12-07</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      fis3学习笔记
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/fis3/">fis3</a></li></ul>
	</div>

        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><em>这几天一直在看fis3，仅通过这篇笔记记录一下自己的学习情况</em><br><a id="more"></a></p>
<hr>
<h2 id="1-_fis简介">1. fis简介</h2><p>fis的全称是Front-end Integrated Solution，即前端集成解决方案。那么问题来了，什么是前端集成解决方案？看看fis团队的解释：</p>
<blockquote>
<p>一个真正的前端团队开发一个产品所需经历的过程：</p>
<ul>
<li>第一阶段： <strong>规范与设计</strong><ul>
<li>定制必要的开发规范</li>
<li>定制项目的组件化拆分方案</li>
</ul>
</li>
<li>第二阶段： <strong>技术选型</strong><ul>
<li>选择前端组件化框架（seajs, requirejs, …）</li>
<li>选择前端基础库（jquery, tangram, …）</li>
<li>选择模板语言（php, smarty, …）</li>
<li>选择模板插件（xss修复）</li>
</ul>
</li>
<li>第三阶段： <strong>自动化与拆分</strong><ul>
<li>选择或开发自动化工具（打包，压缩，校验）</li>
<li>将系统拆分为几个子系统，以便大团队并行开发</li>
<li>适当调整框架以适应工具产出</li>
</ul>
</li>
<li>第四阶段： <strong>性能优化</strong><ul>
<li>小心剔除已下线的功能</li>
<li>优化http请求</li>
<li>适当调整自动化工具以适应性能优化</li>
<li>使用架构级优化方案：BigPipe、BigRender等</li>
</ul>
</li>
</ul>
<p>以上阶段，是所有大型应用前端团队都会经历的阶段，我们将 其中的技术需求总结为前端集成解决方案。</p>
</blockquote>
<p>fis正是为了简化以上过程，诞生于2013年。在2015年8月，配置更加简单，支持更全面的插件扩展的fis3发布了。</p>
<hr>
<h2 id="2-_语言能力">2. 语言能力</h2><p>fis3为前端开发实现了三种编译能力：</p>
<ul>
<li><strong>资源定位</strong>：获取任何开发中所使用资源的线上路径；</li>
<li><strong>内容嵌入</strong>：把一个文件的内容(文本)或者base64编码(图片)嵌入到另一个文件中；</li>
<li><strong>依赖声明</strong>：在一个文本文件内标记对其他资源的依赖关系；</li>
</ul>
<h3 id="1-_资源定位"><strong>1. 资源定位</strong></h3><p>通过资源地位，我们只需要使用相对路径来定位自己的开发资源即可。在默认不配置下，fis3只是将资源相对路径修改成绝对路径，通过配置文件可以将开发路径与部署路径分离<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./fis-config.js</span></span><br><span class="line">fis.match(<span class="string">'*.&#123;png,js,css&#125;'</span>, &#123;</span><br><span class="line">  release: <span class="string">'/static/$0'</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h3 id="2-_内容嵌入"><strong>2. 内容嵌入</strong></h3><p>可以将图片base64嵌入到css、js里，前端模板编译到js文件中，将js、css、html拆分成几个文件最后合并到一起等。<br>html与css中内嵌只需在资源上加?__inline即可实现:<br>源码<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">img</span> <span class="attribute">title</span>=<span class="value">"百度logo"</span> <span class="attribute">src</span>=<span class="value">"images/logo.gif?__inline"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="title">link</span> <span class="attribute">rel</span>=<span class="value">"stylesheet"</span> <span class="attribute">type</span>=<span class="value">"text/css"</span> <span class="attribute">href</span>=<span class="value">"demo.css?__inline"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span> <span class="attribute">src</span>=<span class="value">"demo.js?__inline"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="title">link</span> <span class="attribute">rel</span>=<span class="value">"import"</span> <span class="attribute">href</span>=<span class="value">"demo.html?__inline"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">@import url('demo.css?__inline');</span><br></pre></td></tr></table></figure></p>
<p>编译后<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">img</span> <span class="attribute">title</span>=<span class="value">"百度logo"</span> <span class="attribute">src</span>=<span class="value">"data:image/gif;base64,R0lGODlhDgGBALMAAGBn6eYxLvvy9PnKyfO...Jzna6853wjKc850nPeoYgAgA7"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="title">style</span>&gt;</span><span class="css"><span class="tag">img</span> <span class="rules">&#123; <span class="rule"><span class="attribute">border</span>:<span class="value"> <span class="number">5px</span> solid <span class="hexcolor">#ccc</span></span></span>; &#125;</span></span><span class="tag">&lt;/<span class="title">style</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span>&gt;</span><span class="applescript">console.<span class="command">log</span>('inline <span class="type">file</span>');</span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="title">h1</span>&gt;</span>demo.html content<span class="tag">&lt;/<span class="title">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line">img &#123; border: 5px solid #ccc; &#125;;</span><br></pre></td></tr></table></figure></p>
<p>在JS中稍微不一样<br>源码<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__inline(<span class="string">'demo.js'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> img = __inline(<span class="string">'images/logo.gif'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> css = __inline(<span class="string">'a.css'</span>);</span><br></pre></td></tr></table></figure></p>
<p>编译后<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">'demo.js content'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> img = <span class="string">'data:image/gif;base64,R0lGODlhDgGBALMAAGBn6eYxLvvy9PnKyfO...Jzna6853wjKc850nPeoYgAgA7'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> css = <span class="string">"body \n&#123;    color: red;\n&#125;"</span>;</span><br></pre></td></tr></table></figure></p>
<h3 id="3-_声明依赖"><strong>3. 声明依赖</strong></h3><p>FIS3 在执行编译的过程中，会扫描这些编译标记，从而建立一张静态资源关系表，资源关系表详细记录了项目内的静态资源id、发布后的线上路径、资源类型以及 依赖关系 和 资源打包 等信息。</p>
<h4 id="html中声明依赖：">html中声明依赖：</h4><p>用户可以在html的注释中声明依赖关系，这些依赖关系最终会被记录下来，当某个文件中包含字符 <strong>RESOURCE_MAP</strong> 那么这个记录会被字符串化后替换 <strong>RESOURCE_MAP</strong>。假设项目根目录下有个文件 manifest.json包含此字符，编译后会把表结构替换到这个文件中。<br>在项目的index.html里使用注释声明依赖关系：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span><br><span class="line">    @require demo.js</span><br><span class="line">    @require "demo.css"</span><br><span class="line">--&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>默认情况下，只有js和css文件会输出到manifest.json表中，如果想将html文件加入表中，需要通过配置 useMap 让HTML文件加入 manifest.json，例如：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//fis-conf.js</span><br><span class="line">fis.match('*.html', &#123;</span><br><span class="line">    useMap: true</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>编译后在输出目录查看manifest.json文件:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"res"</span> : &#123;</span><br><span class="line">        <span class="string">"index.html"</span> : &#123;</span><br><span class="line">            <span class="string">"uri"</span> : <span class="string">"/index.html"</span>,</span><br><span class="line">            <span class="string">"type"</span> : <span class="string">"html"</span>,</span><br><span class="line">            <span class="string">"deps"</span> : [ <span class="string">"demo.js"</span>, <span class="string">"demo.css"</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"pkg"</span> : &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>js与css的配置方式与html一样。</p>
<hr>
<h2 id="3-_调试">3. 调试</h2><p>FIS3 构建后，默认情况下会对资源的 URL 进行修改，改成绝对路径。这时候本地双击打开文件是无法正常工作的。这给开发调试带来了绝大的困惑。因此FIS3 内置一个简易 Web Server，可以方便调试构建结果。</p>
<ol>
<li>开启server到内置server调试目录<br><code>fis3 server open</code></li>
<li>发布到内置server发布目录<br><code>fis3 release</code><br>不加 -d 参数默认被发布到内置 Web Server的根目录下，当启动服务时访问此目录下的资源。</li>
<li><p>文件监听</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fis3 release -w    <span class="comment">//FIS3 通过对 release 命令添加 -w 或者 --watch 参数启动文件监听功能。</span></span><br><span class="line"></span><br><span class="line">fis3 release -wL  <span class="comment">//文件修改自动构建发布了，如果浏览器能自动刷新。</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>发布配置 发布只需要配置就可以完成</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fis.match(<span class="string">'*'</span>, &#123;</span><br><span class="line">    deploy: fis.plugin(<span class="string">'http-push'</span>, &#123;</span><br><span class="line">        receiver: <span class="string">'http://cq.01.p.p.baidu.com:8888/receiver.php'</span>,</span><br><span class="line">        to: <span class="string">'/home/work/htdocs'</span> <span class="comment">// 注意这个是指的是测试机器的路径，而非本地机器</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<h2 id="4-_工作原理">4. 工作原理</h2><p>FIS3 是基于文件对象进行构建的，每个进入 FIS3 的文件都会实例化成一个 File 对象，整个构建过程都对这个对象进行操作完成构建任务。</p>
<h3 id="1-_构建流程"><strong>1. 构建流程</strong></h3><p>下面来看一下官方给出的用来阐述FIS3构建流程的伪码:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">fis.release = <span class="function"><span class="keyword">function</span> <span class="params">(opt)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> src = fis.util.find(fis.project.root);</span><br><span class="line">  <span class="keyword">var</span> files = &#123;&#125;;</span><br><span class="line">  src.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(f)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> file = <span class="keyword">new</span> File(f);</span><br><span class="line">    files[file.subpath] = fis.compile(file);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">var</span> packager = fis.matchRules(<span class="string">'::package'</span>);</span><br><span class="line">  <span class="keyword">var</span> keys = <span class="built_in">Object</span>.keys(packager);</span><br><span class="line">  <span class="keyword">var</span> ret = &#123;</span><br><span class="line">    files: files,</span><br><span class="line">    map: &#123;&#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">if</span> (packager.indexOf(<span class="string">'prepackager'</span>) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">    pipe(<span class="string">'prepackager'</span>, ret);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (packager.indexOf(<span class="string">'packager'</span>) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">    pipe(<span class="string">'packager'</span>, ret);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  files.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(f)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 打包阶段产出的 map 表替换到文件</span></span><br><span class="line">    <span class="keyword">if</span> (f._isResourceMap) &#123;</span><br><span class="line">      f._content = f._content.replace(<span class="regexp">/\b__RESOURCE_MAP__\b/g</span>, <span class="built_in">JSON</span>.stringify(ret.map));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (packager.indexOf(<span class="string">'spriter'</span>) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">    pipe(<span class="string">'spriter'</span>, ret);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (packager.indexOf(<span class="string">'postpackager'</span>) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">    pipe(<span class="string">'postpackager'</span>, ret);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如上述代码，整个 fis3 的构建流程大题概括分为三个阶段。</p>
<ul>
<li>扫描项目目录拿到文件并初始化出一个文件对象列表</li>
<li>对文件对象中每一个文件进行单文件编译</li>
<li>获取用户设置的 <code>package</code> 插件，进行打包处理（包括合并图片）</li>
</ul>
<p>其中打包处理开了四个扩展点，通过用户配置启用某些插件。</p>
<ul>
<li>prepackager 打包前处理插件扩展点</li>
<li>packager 打包插件扩展点，通过此插件收集文件依赖信息、合并信息产出静态资源映射表</li>
<li>spriter 图片合并扩展点，如 csssprites</li>
<li>postpackager 打包后处理插件扩展点</li>
</ul>
<h3 id="2-_单文件编译流程"><strong>2. 单文件编译流程</strong></h3><p>伪码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">fis.compile = <span class="function"><span class="keyword">function</span> <span class="params">(file)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (file.isFile()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (exports.useLint &amp;&amp; file.lint) &#123;</span><br><span class="line">      pipe(<span class="string">'lint'</span>, file);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!file.hasCache) &#123;</span><br><span class="line">      process(file);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      file.revertCache();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    process(file);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">process</span><span class="params">(file)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (file.parser) &#123;</span><br><span class="line">    pipe(<span class="string">'parser'</span>, file);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (file.preprocessor) &#123;</span><br><span class="line">    pipe(<span class="string">'preprocessor'</span>, file);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (file.standard) &#123;</span><br><span class="line">    standard(file); <span class="comment">// 标准化处理</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (file.postprocessor) &#123;</span><br><span class="line">    pipe(<span class="string">'postprocessor'</span>, file);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (file.optimizer) &#123;</span><br><span class="line">    pipe(<span class="string">'optimizer'</span>, file);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中插件扩展点包括：</p>
<ul>
<li>lint：代码校验检查，比较特殊，所以需要 <code>release</code> 命令命令行添加 <code>-l</code> 参数</li>
<li>parser：预处理阶段，比如 less、sass、es6、react 前端模板等都在此处预编译处理</li>
<li>preprocessor：标准化前处理插件</li>
<li>standard：标准化插件，处理内置语法</li>
<li>postprocessor：标准化后处理插件</li>
</ul>
<p>单文件阶段通过读取文件属性，来执行对应扩展点插件。例如：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fis.match(<span class="string">'*.es6'</span>, &#123;</span><br><span class="line">  parser: fis.plugin(<span class="string">'babel'</span>),</span><br><span class="line">  rExt: <span class="string">'.js'</span> <span class="comment">// 代码编译产出时，后缀改成 .js</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>给后缀是 .es6 的文件配置了一个 parser 属性，属性值是启用了一个叫 babel 的插件，当执行到预处理阶段时，将 es6 编译为 es5，供浏览器执行,其他插件扩展点亦然。</p>
<h3 id="3-_File_对象"><strong>3. File 对象</strong></h3><p>伪码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">File</span><span class="params">(filepath)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> props = path.info(filepath);</span><br><span class="line">  merge(props, fis.matchRules(filepath)); <span class="comment">// merge 分配到的属性</span></span><br><span class="line">  assign(<span class="keyword">this</span>, props); <span class="comment">// merge 属性到对象</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当一个文件被实例化为一个 File 对象后，包括一些文件基本属性，如 filename、realpath 等等，当这个文件被处理时，FIS3 还会把用户自定义的属性 merge 到文件对象上。例如：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fis.match(<span class="string">'a.js'</span>, &#123;</span><br><span class="line">  myProp: <span class="literal">true</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>这样fis3将为这个文件加上myProp属性。</p>
<hr>
<h2 id="5-_配置API">5. 配置API</h2><h3 id="1-_fis-set()">1. fis.set()</h3><p>设置一些配置，如系统内置属性 <code>project</code>、<code>namespace</code>、<code>modules</code>、<code>settings</code>。 <code>fis.set</code> 设置的值通过fis.get()获取。</p>
<h4 id="语法">语法</h4><p><code>fis.set(key, value)</code></p>
<h4 id="参数">参数</h4><ul>
<li>key<br> 任意字符串，但系统占用了 project、namespace、modules、settings 它们在系统中有特殊含义.</li>
<li>value<br> 任意变量</li>
</ul>
<h4 id="例">例</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fis.set(<span class="string">'namespace'</span>, <span class="string">'home'</span>);</span><br><span class="line">fis.set(<span class="string">'my project namespace'</span>, <span class="string">'common'</span>);</span><br><span class="line">fis.set(<span class="string">'a.b.c'</span>, <span class="string">'some value'</span>); <span class="comment">// fis.get('a') =&gt; &#123;b: &#123;c: 'some value'&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="2-_fis-get()">2. fis.get()</h3><p>获取已经配置的属性，和 fis.set() 成对使用</p>
<h4 id="语法-1">语法</h4><p><code>fis.get(key)</code></p>
<h4 id="参数-1">参数</h4><ul>
<li>key<br> 任意字符串</li>
</ul>
<h4 id="例-1">例</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// fis.set(&#39;namespace&#39;, &#39;common&#39;)&#10;var ns = fis.get(&#39;namespace&#39;);&#10;&#10;// fis.set(&#39;a.b.c&#39;, &#39;d&#39;)&#10;fis.get(&#39;a&#39;); // =&#62; &#123;b:&#123;c: &#39;d&#39;&#125;&#125;&#10;fis.get(&#39;a.b&#39;); // =&#62; &#123;c:&#39;d&#39;&#125;&#10;fis.get(&#39;a.b.c&#39;); // =&#62; &#39;d&#39;</span><br></pre></td></tr></table></figure>
<h3 id="3-_fis-match()">3. fis.match()</h3><p>给匹配到的文件分配属性，文件属性决定了这个文件进行怎么样的操作。</p>
<h4 id="语法-2">语法</h4><p><code>fis.match(selector, props[,important])</code></p>
<h4 id="参数-2">参数</h4><ul>
<li>selector<br> glob或是任意正则</li>
<li>props<br> 文件属性</li>
<li>important<br> bool设置，若为true则表示设置的规则无法被覆盖，参考CSS的<code>!important</code></li>
</ul>
<h4 id="例子">例子</h4><p>fis.match 模拟一个类似 css 的覆盖规则，负责给文件分配规则属性，这些规则属性决定了这个文件将会被如何处理，就像 css 的规则一样，后面分配到的规则会覆盖前面的。如<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">fis.match(<span class="string">'&#123;a,b&#125;.js'</span>, &#123;</span><br><span class="line">    release: <span class="string">'/static/$0'</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">fis.match(<span class="string">'b.js'</span>, &#123;</span><br><span class="line">    release: <span class="string">'/static/new/$0'</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>b.js 最终分配到的规则属性是<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    release: <span class="string">'/static/new/$0'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>那么 b.js 将会产出到 /static/new 目录下.</p>
<h3 id="4-_fis-media()">4. fis.media()</h3><p>fis.media 是模仿自 css 的 @media，表示不同的状态。这是 fis3 中的一个重要概念，其意味着有多份配置，每一份配置都可以让 fis3 进行不同的编译；</p>
<p>比如开发时和上线时的配置不同，比如部署测试机时测试机器目录不同，比如测试环境和线上机器的静态资源 domain 不同，一切这些不同都可以设定特定的 fis.media 来搞定。</p>
<h4 id="语法-3">语法</h4><p><code>fis.media(mode)</code></p>
<h4 id="参数-3">参数</h4><ul>
<li>mode<br> <code>string</code> mode，设定不同状态，比如 <code>rd</code>、<code>qa</code>、<code>dev</code>、<code>production</code></li>
</ul>
<h4 id="例-2">例</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">fis.media(<span class="string">'rd'</span>).match(<span class="string">'*'</span>, &#123;</span><br><span class="line">  deploy: fis.plugin(<span class="string">'http-push'</span>, &#123;</span><br><span class="line">    receiver: <span class="string">'http://remote-rd-host/receiver.php'</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">fis.media(<span class="string">'qa'</span>).match(<span class="string">'*'</span>, &#123;</span><br><span class="line">  deploy: fis.plugin(<span class="string">'http-push'</span>, &#123;</span><br><span class="line">    receiver: <span class="string">'http://remote-qa-host/receiver.php'</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<ul>
<li><code>fis3 release rd push</code> 到 RD 的远端机器上</li>
<li><code>fis3 release qa push</code> 到 QA 的远端机器上</li>
</ul>
<h3 id="5-_fis-plugin()">5. fis.plugin()</h3><p>插件调用接口</p>
<h4 id="参数-4">参数</h4><ul>
<li>name<br> 插件名，<strong>需要说明的是</strong>，fis3固定了插件扩展点，每一个插件都有个类型，体现在插件发布的 npm 包名字上；比如<code>fis-parser-less</code>插件，<code>parser</code>指的是在 <code>parser</code> 扩展点做了个解析 <code>.less</code> 的插件。所以在设置时，插件名应该是<code>less</code>，而不是<code>fis-parser-less</code>。</li>
<li>props<br> 对象，给插件设置用户属性</li>
<li>position<br> 设置插件位置，如果目标文件已经设置了某插件，默认再次设置会覆盖掉。如果希望在已设插件执行之前插入或者之后插入，请传入 <code>prepend</code> 或者 <code>append</code></li>
</ul>
<h4 id="例-3">例</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  fis.match(<span class="string">'*.less'</span>, &#123;</span><br><span class="line">      parser: fis.plugin(<span class="string">'less'</span>, &#123;&#125;) <span class="comment">//属性 parser 表示了插件的类型</span></span><br><span class="line">  &#125;)</span><br><span class="line">  </span><br><span class="line">  fis.match(<span class="string">'*.less'</span>, &#123;</span><br><span class="line">   parser: fis.plugin(<span class="string">'another'</span>, <span class="literal">null</span>, <span class="string">'append'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="6-_全局属性介绍">6. 全局属性介绍</h2><p>全局属性通过<code>fis.set</code>设置，通过<code>fis.get</code>获取。<br>内置的默认配置<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> DEFAULT_SETTINGS = &#123;</span><br><span class="line">  project: &#123;</span><br><span class="line">    charset: <span class="string">'utf8'</span>,    <span class="comment">//字符编码，@param: string</span></span><br><span class="line">    md5Length: <span class="number">7</span>,    <span class="comment">//md5长度， @param: number</span></span><br><span class="line">    md5Connector: <span class="string">'_'</span>,    <span class="comment">//设置md5与文件的连接字符，@param: string</span></span><br><span class="line">    files: [<span class="string">'**'</span>],    <span class="comment">//设置项目源码文件过滤器，@param:</span></span><br><span class="line">    ignore: [<span class="string">'node_modules/**'</span>, <span class="string">'output/**'</span>, <span class="string">'.git/**'</span>, <span class="string">'fis-conf.js'</span>]    <span class="comment">//排除某些不处理的文件</span></span><br><span class="line">    fileType:&#123;</span><br><span class="line">        text: [<span class="string">'html'</span>, <span class="string">'js'</span>],    <span class="comment">//追加文本文件后缀列表，@param: array | string</span></span><br><span class="line">        image: [<span class="string">'png'</span>]    <span class="comment">//最佳图片类二进制文件后缀列表，@param: array | string</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// project的属性也可以通过 fis.set('project.charset', 'utf8') 来设置，其它的类似</span></span><br><span class="line"></span><br><span class="line">  component: &#123;</span><br><span class="line">    skipRoadmapCheck: <span class="literal">true</span>,  </span><br><span class="line">    protocol: <span class="string">'github'</span>,</span><br><span class="line">    author: <span class="string">'fis-components'</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  modules: &#123;</span><br><span class="line">    hook: <span class="string">'components'</span>,</span><br><span class="line">    packager: <span class="string">'map'</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  options: &#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>默认配置都能使用<code>fis.set</code>覆盖，除默认属性外，还有<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fis.set(<span class="string">'project.fileType.text'</span>, <span class="string">'tpl, js, css'</span>);  <span class="comment">//追加文本文件后缀列表</span></span><br><span class="line"></span><br><span class="line">fis.set(<span class="string">'project.fileType.image'</span>, <span class="string">'swf, cur, ico'</span>);  <span class="comment">//追加图片类二进制文件后缀列表</span></span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="7-_文件属性介绍">7. 文件属性介绍</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">fis.set(<span class="string">'timeDate'</span>, <span class="built_in">Date</span>.now());    <span class="comment">//获取当前时间戳</span></span><br><span class="line">fis.match(<span class="string">'/widget/&#123;*,**/*&#125;.js'</span>, &#123;</span><br><span class="line">    charset: <span class="string">'utf8'</span>,    <span class="comment">//指定文本文件的输出编码。@param: string</span></span><br><span class="line">    url: <span class="string">'/static/proj/pkg_widget.js'</span>, <span class="comment">//指定文件的资源定位路径，以 / 开头。默认是 release 的值，url可以与发布路径 release 不一致。@param: string</span></span><br><span class="line">    release: <span class="string">'/static/$0'</span>,    <span class="comment">//设置文件的产出路径。设置为false表示不生成文件,@param: string</span></span><br><span class="line">    packTo: <span class="string">'/static/pkg_widget.js'</span>,     <span class="comment">//分配到这个属性的文件将会合并到这个属性配置的文件中,@param: string</span></span><br><span class="line">    query: <span class="string">'?=t'</span> + fis.get(<span class="string">'timeDate'</span>),    <span class="comment">//指定文件的资源定位路径之后的query，比如'?t=123124132'。@param: string</span></span><br><span class="line">    isHtmlLike: <span class="literal">true</span>,     <span class="comment">//指定对文件进行 html 相关语言能力处理.@param: bool</span></span><br><span class="line">    isCssLike: <span class="literal">true</span>,     <span class="comment">//指定对文件进行 css 相关的语言能力处理.@param: bool</span></span><br><span class="line">    isJsLike: <span class="literal">true</span>,    <span class="comment">//指定对文件进行 js 相关的语言能力处理</span></span><br><span class="line">    useSameNameRequire: <span class="literal">true</span>,    <span class="comment">//开启同名依赖.@param: bool</span></span><br><span class="line">    requires:[    <span class="comment">//默认依赖的资源id表</span></span><br><span class="line">        <span class="string">''</span>static/lib/jquery.js<span class="string">''</span></span><br><span class="line">    ],</span><br><span class="line">    extras: &#123;    <span class="comment">//在[静态资源映射表][]中的附加数据，用于扩展[静态资源映射表][]表的功能。@param: object</span></span><br><span class="line">        isPage: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">fis.match(<span class="string">'/widget/mod.js'</span>, &#123;</span><br><span class="line">    packOrder: -<span class="number">100</span>,     <span class="comment">//用来控制合并时的顺序，值越小越在前面。配合 packTo 一起使用。@param:number</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">fis.match(<span class="string">'/widget/jquery.js'</span>, &#123;</span><br><span class="line">    <span class="comment">//使用 var $ = require('jquery');</span></span><br><span class="line">    id: <span class="string">'query'</span>,    <span class="comment">//指定文件的资源id。默认是 namespace + subpath 的值,@param: string</span></span><br><span class="line">    moduleId: <span class="string">'jquery'</span>,    <span class="comment">//指定文件资源的模块id。在插件fis3-hook-module里面自动包裹define的时候会用到，默认是 id 的值。@param: string</span></span><br><span class="line">    isMod: <span class="literal">true</span>    <span class="comment">//标示文件是否为组件化文件。@param: bool</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">fis.media(<span class="string">'prod'</span>).match(<span class="string">'*.css'</span>, &#123;</span><br><span class="line">    useHash: <span class="literal">true</span>,     <span class="comment">//是否携带md5戳。@param: true</span></span><br><span class="line">    domain: <span class="string">'http://www.qq.com'</span>,   <span class="comment">//给文件 URL 设置cdn替换前缀。@paran: string</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">fis.match(<span class="string">'*.less'</span>, &#123;</span><br><span class="line">    rExt: <span class="string">'.css'</span>    <span class="comment">//设置最终文件产出后的后缀.@param: string</span></span><br><span class="line">    userMap: <span class="literal">true</span>,    <span class="comment">//文件信息是否添加到 map.json,用于处理声明依赖，后面会讲到。@param: bool</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="8-_fis3常用配置">8. fis3常用配置</h2><h3 id="1-_项目开发基本规范">1. 项目开发基本规范</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 开发目录规范</span></span><br><span class="line">.</span><br><span class="line">├── page    <span class="comment">// 放置页面模板</span></span><br><span class="line">│   └── index.html</span><br><span class="line">├── static    <span class="comment">//公用静态资源</span></span><br><span class="line">│   └── lib   <span class="comment">//放置一些公共库，例如 jquery, zepto, lazyload 等 //公用静态资源库。例如jquery、zepto等</span></span><br><span class="line">├── test    <span class="comment">//一些测试数据和用例</span></span><br><span class="line">└── widget    <span class="comment">//一切组件，包括模板、css、js、图片以及其他前端资源</span></span><br><span class="line">    ├── header</span><br><span class="line">    ├── nav</span><br><span class="line">    └── ui</span><br><span class="line"></span><br><span class="line"><span class="comment">//发布部署规范</span></span><br><span class="line">.</span><br><span class="line">├── static    <span class="comment">//所有的静态资源都放到这个目录下</span></span><br><span class="line">├── template    <span class="comment">//所有的模板都放到这个目录下</span></span><br><span class="line">└── test    还是一些测试数据、用例</span><br><span class="line"></span><br><span class="line"><span class="comment">//构建工具配置</span></span><br><span class="line">foo</span><br><span class="line">foo/bin/foo.js</span><br><span class="line">foo/index.js</span><br><span class="line">package.json</span><br></pre></td></tr></table></figure>
<h3 id="2-_为制定目录规范编写的fis-conf-js文件">2. 为制定目录规范编写的fis-conf.js文件</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 所有的文件产出到 static/ 目录下</span></span><br><span class="line">fis.match(<span class="string">'*'</span>, &#123;</span><br><span class="line">    release: <span class="string">'/static/$0'</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 所有模板放到 tempalte 目录下</span></span><br><span class="line">fis.match(<span class="string">'*.html'</span>, &#123;</span><br><span class="line">    release: <span class="string">'/template/$0'</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// widget源码目录下的资源被标注为组件</span></span><br><span class="line">fis.match(<span class="string">'/widget/**/*'</span>, &#123;</span><br><span class="line">    isMod: <span class="literal">true</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// widget下的 js 调用 jswrapper 进行自动化组件化封装</span></span><br><span class="line">fis.match(<span class="string">'/widget/**/*.js'</span>, &#123;</span><br><span class="line">    postprocessor: fis.plugin(<span class="string">'jswrapper'</span>, &#123;</span><br><span class="line">        type: <span class="string">'commonjs'</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// test 目录下的原封不动产出到 test 目录下</span></span><br><span class="line">fis.match(<span class="string">'/test/**/*'</span>, &#123;</span><br><span class="line">    release: <span class="string">'$0'</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="3-_进一步优化">3. 进一步优化</h3><ul>
<li>js,css在开发时不压缩，但在产品发布是压缩</li>
<li>代码进行合理的合并处理</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 所有的文件产出到 static/ 目录下</span></span><br><span class="line">fis.match(<span class="string">'*'</span>, &#123;</span><br><span class="line">    release: <span class="string">'/static/$0'</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 所有模板放到 tempalte 目录下</span></span><br><span class="line">fis.match(<span class="string">'*.html'</span>, &#123;</span><br><span class="line">    release: <span class="string">'/template/$0'</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// widget源码目录下的资源被标注为组件</span></span><br><span class="line">fis.match(<span class="string">'/widget/**/*'</span>, &#123;</span><br><span class="line">    isMod: <span class="literal">true</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// widget下的 js 调用 jswrapper 进行自动化组件化封装</span></span><br><span class="line">fis.match(<span class="string">'/widget/**/*.js'</span>, &#123;</span><br><span class="line">    postprocessor: fis.plugin(<span class="string">'jswrapper'</span>, &#123;</span><br><span class="line">        type: <span class="string">'commonjs'</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// test 目录下的原封不动产出到 test 目录下</span></span><br><span class="line">fis.match(<span class="string">'/test/**/*'</span>, &#123;</span><br><span class="line">    release: <span class="string">'$0'</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// optimize</span></span><br><span class="line">fis.media(<span class="string">'prod'</span>)</span><br><span class="line">    .match(<span class="string">'*.js'</span>, &#123;</span><br><span class="line">        optimizer: fis.plugin(<span class="string">'uglify-js'</span>, &#123;</span><br><span class="line">            mangle: &#123;</span><br><span class="line">                expect: [<span class="string">'require'</span>, <span class="string">'define'</span>, <span class="string">'some string'</span>] <span class="comment">//不想被压的</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    .match(<span class="string">'*.css'</span>, &#123;</span><br><span class="line">        optimizer: fis.plugin(<span class="string">'clean-css'</span>, &#123;</span><br><span class="line">            <span class="string">'keepBreaks'</span>: <span class="literal">true</span> <span class="comment">//保持一个规则一个换行</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// pack</span></span><br><span class="line">fis.media(<span class="string">'prod'</span>)</span><br><span class="line">    <span class="comment">// 启用打包插件，必须匹配 ::package</span></span><br><span class="line">    .match(<span class="string">'::package'</span>, &#123;</span><br><span class="line">        packager: fis.plugin(<span class="string">'map'</span>),</span><br><span class="line">        spriter: fis.plugin(<span class="string">'csssprites'</span>, &#123;</span><br><span class="line">            layout: <span class="string">'matrix'</span>,</span><br><span class="line">            margin: <span class="string">'15'</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    .match(<span class="string">'*.js'</span>, &#123;</span><br><span class="line">        packTo: <span class="string">'/static/all_others.js'</span></span><br><span class="line">    &#125;)</span><br><span class="line">    .match(<span class="string">'*.css'</span>, &#123;</span><br><span class="line">        packTo: <span class="string">'/staitc/all_others.css'</span></span><br><span class="line">    &#125;)</span><br><span class="line">    .match(<span class="string">'/widget/**/*.js'</span>, &#123;</span><br><span class="line">        packTo: <span class="string">'/static/all_comp.js'</span></span><br><span class="line">    &#125;)</span><br><span class="line">    .match(<span class="string">'/widget/**/*.css'</span>, &#123;</span><br><span class="line">        packTo: <span class="string">'/static/all_comp.css'</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<ul>
<li>发布 <code>fis3 release prod</code>，进行合并、压缩等优化</li>
<li>发布 <code>fis3 release</code> 不做压缩不做合并</li>
</ul>
<h3 id="4-_部署远端测试机">4. 部署远端测试机</h3><p>首先选定自己需要使用的deploy插件，在fis3部署方式都是用插件实现的。</p>
<ul>
<li><code>fis3-deploy-http-push</code></li>
</ul>
<p>这个插件就是以 HTTP 提交的方式来完成远端部署的，当然由于安全性等原因这种方式只适用于测试阶段，请勿直接拿来上线；</p>
<p>HTTP 提交的方式上传就得有一个接受端，<code>http-push</code> 提供了一个 php 版本的接收端 receiver.php ，其他后端可以模仿实现一个。这个接收端需要放到你的 Web 服务 WWW 目录下，并且可以被访问到；</p>
<p>部署好接收端，并且它能正常被访问到，比如 url 是 <code>http:///receiver.php</code> 其配置如下<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fis.media(<span class="string">'qa'</span>).match(<span class="string">'**'</span>, &#123;</span><br><span class="line">    deploy:  fis.plugin(<span class="string">'http-push'</span>, &#123;</span><br><span class="line">        receiver: <span class="string">'http:///receiver.php'</span>,</span><br><span class="line">        to: <span class="string">'/home/work/www'</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<ul>
<li><code>fis3 release qa</code> 当执行时就会部署到配置的 qa 的机器上。</li>
</ul>
<h2 id="9-_结语">9. 结语</h2><p>因为只挑了重点的讲，所以写的并不是太全面（尽管大多都是官方文档里的内容)，接下来准备通过一个demo来展示fis3与fis2的不同之处。</p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2015/12/04/fis3/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">fis3的运行过程简略分析</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">分享到：</span>
		<a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
		<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>



<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="fis3-study-note" data-title="fis3学习笔记" data-url="http://yoursite.com/2015/12/07/fis3-study-note/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"jyc"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>



</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2015 jyc
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/mobile.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>





<! -- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



  </div>
</body>
</html>